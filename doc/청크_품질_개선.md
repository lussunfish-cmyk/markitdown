# 청크 품질 개선

## 개선 사항

### 1. **헤더 기반 섹션 분할**
- 마크다운 헤더(#, ##, ###)를 인식하여 의미 있는 단위로 청크 생성
- 섹션 경계를 존중하여 문맥이 끊기지 않도록 개선

### 2. **컨텍스트 헤더 추가**
각 청크에 상위 헤더 계층 정보가 자동으로 포함됩니다:

**변경 전:**
```
5G 네트워크는 높은 대역폭과 낮은 지연시간을 제공합니다...
```

**변경 후:**
```
[5G 기술 > 네트워크 특성]

5G 네트워크는 높은 대역폭과 낮은 지연시간을 제공합니다...
```

### 3. **청크 크기 최적화**
- **CHUNK_SIZE**: 512 → 800 (더 풍부한 컨텍스트)
- **CHUNK_OVERLAP**: 128 → 200 (더 나은 연속성)

### 4. **메타데이터 강화**
각 청크에 다음 정보가 저장됩니다:
- `section_title`: 섹션 제목 및 계층 정보
- `source`: 원본 파일 경로
- `chunk_id`: 청크 순번
- `total_chunks`: 전체 청크 수

### 5. **RAG 컨텍스트 개선**
검색 시 섹션 제목이 함께 표시되어 LLM이 더 정확한 답변 생성:

```
[1] 5G 기술 > 네트워크 특성 (from 5G_network.md)
5G 네트워크는 높은 대역폭과 낮은 지연시간을 제공합니다...

[2] 5G 기술 > 응용 분야 (from 5G_network.md)
자율주행, IoT, 원격 의료 등 다양한 분야에 활용됩니다...
```

## 적용 방법

### 재인덱싱 필요
기존 문서들은 새로운 청킹 방식을 적용받으려면 재인덱싱이 필요합니다:

```bash
# 1. 벡터 저장소 초기화
rm -rf vector_store/*

# 2. 문서 재인덱싱 (API 호출)
curl -X POST http://localhost:8000/index \
  -H "Content-Type: application/json" \
  -d '{"force_reindex": true}'
```

또는 Python에서:
```python
from app.indexer import DocumentIndexer

indexer = DocumentIndexer()
result = indexer.index_all(force_reindex=True)
print(f"재인덱싱 완료: {result.indexed_files}개 파일")
```

### 새 문서 인덱싱
새로운 문서는 자동으로 개선된 청킹이 적용됩니다.

## 예상 효과

1. **더 정확한 검색**: 의미 단위로 분할되어 관련성 높은 청크 검색
2. **더 나은 답변 품질**: LLM이 컨텍스트를 더 잘 이해
3. **명확한 출처**: 섹션 제목으로 정보의 위치 파악 용이
4. **연속성 향상**: 증가된 overlap으로 문맥 손실 최소화

## 기술 세부사항

### MarkdownChunker 개선
```python
# 헤더 계층 추출
sections = self._extract_sections(text)

# 각 섹션을 청크로 변환 (컨텍스트 헤더 포함)
for section in sections:
    chunks = self._chunk_section(section)
    # 결과: "[부모 헤더 > 현재 헤더]\n\n내용"
```

### 섹션 정보 전파
```python
# DocumentMetadata에 section_title 추가
metadata = DocumentMetadata(
    source=source,
    chunk_id=idx,
    total_chunks=total_chunks,
    section_title="5G 기술 > 네트워크 특성"  # 자동 추출
)
```

## 추가 최적화 가능 사항

향후 개선 가능한 부분:
- [ ] 문장 경계 더 정교하게 인식 (NLTK/spaCy)
- [ ] 표(table), 리스트 구조 인식
- [ ] 코드 블록 완전성 보장
- [ ] 이미지/링크 참조 유지

## 데이터 흐름

### 1. 청크 생성 프로세스
```
Markdown 원문
    ↓
계층 구조 분석 (MarkItDown)
    ↓
섹션 트리 생성 (Header 기반)
    ↓
텍스트 분할 (Chunking)
    ├─► 섹션 단위 분리
    └─► 오버랩 적용 (200자)
    ↓
메타데이터 주입
    ├─► section_title (계층 정보)
    └─► chunk_id / total_chunks
    ↓
최종 청크 리스트 반환
```
