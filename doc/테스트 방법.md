# 테스트 방법

## ollama 컨테이너 실행

    docker run -d --gpus=all -v ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama
    docker exec -it ollama ollama run gemma2

## markitdown-api 컨테이너 실행

    docker compose up -d --build

## 개별 테스트 파일 실행

### basic

    docker compose cp test_basic.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_basic.py

### embedding

    docker compose cp test_embedding.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_embedding.py

### vector_store

    docker compose cp test_vector_store.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_vector_store.py

### retriever

    docker compose cp test_retriever.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_retriever.py

### rag

    docker compose cp test_rag.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_rag.py
    
### indexer

    docker compose cp test_indexer.py markitdown-api:/app/
    docker compose exec -T markitdown-api python test_indexer.py

### evaluator (평가 시스템)

    # 별도의 단위 테스트 파일이 없다면 API를 통해 테스트 수행 (아래 참조)


## 종합 테스트 (FastAPI 통합 테스트)

### 준비 단계

#### 1. 벡터 저장소 초기화

```bash
# 기존 데이터 삭제
sudo rm -rf ./vector_store ./batch_state

# 컨테이너 재시작
docker compose restart app

# 서비스 정상 실행 확인
sleep 5
curl http://localhost:8000/health
```

#### 2. 테스트 문서 준비

**옵션 A: 샘플 마크다운 파일 생성**

```bash
mkdir -p ./test_docs

# 테스트 문서 1: 5G 네트워크
cat > ./test_docs/5G_network.md << 'EOF'
# 5G 네트워크 기술

## 개요
5G는 5세대 이동통신 기술로 초고속, 초저지연, 초연결을 특징으로 합니다.

## 주요 특징
- **초고속 데이터 전송**: 최대 20Gbps의 다운로드 속도
- **초저지연**: 1ms 이하의 응답 시간
- **대규모 연결**: 1km² 당 100만 개 기기 동시 연결
- **네트워크 슬라이싱**: 용도별 가상 네트워크 구성

## 주파수 대역
5G는 다양한 주파수 대역을 사용합니다:
- Sub-6 GHz: 3~6 GHz 대역
- mmWave: 28 GHz, 39 GHz 대역

## 적용 분야
- 스마트 시티
- 자율주행 자동차
- 가상현실 (VR)
- 원격 의료
EOF

# 테스트 문서 2: VoLTE 기술
cat > ./test_docs/volte_technology.md << 'EOF'
# VoLTE (Voice over LTE) 기술

## VoLTE란?
VoLTE는 LTE 네트워크를 통해 음성 통화를 제공하는 기술입니다.

## 기본 개념
- IP Multimedia Subsystem (IMS) 기반
- 패킷 기반 음성 통화
- 기존 회선교환식 음성 방식 대체

## 주요 장점
- 더 빠른 통화 연결
- 고음질 음성 전송
- 통화 중 데이터 사용 가능
- 배터리 소비 감소

## ViLTE (Video over LTE)
- VoLTE 기반의 영상통화 기술
- 4G/LTE 네트워크에서 고화질 영상통화 제공
- IMS 기반 구조 동일

## 상호운용성
VoLTE와 ViLTE의 상호운용성 테스트는 다양한 단말기 및 네트워크 환경에서 이루어집니다.
EOF

# 테스트 문서 3: femtocell 기술
cat > ./test_docs/femtocell.md << 'EOF'
# Femtocell (소형 기지국) 기술

## Femtocell 정의
Femtocell은 실내 또는 소규모 지역의 이동통신 신호를 강화하기 위한 소형 기지국입니다.

## 성능 특성
- 범위: 10~50m
- 용량: 수십 명의 사용자 지원
- 전력소비: W 단위
- 백홀: ADSL, 광대역 또는 LTE

## 5G Femtocell의 특징
5G 네트워크에서는 femtocell이 더욱 중요해지고 있습니다:
- 초고속 데이터 전송: 20Gbps 이상
- 초저지연: 1ms 이하
- 용도별 네트워크 슬라이싱 지원

## 배포 장점
- 비용 효율적인 커버리지 확대
- 실내 신호 강화
- 에너지 효율성
- 용량 증대
EOF

# 테스트 문서 4: 네트워크 인터페이스
cat > ./test_docs/network_interfaces.md << 'EOF'
# 이동통신 네트워크 인터페이스

## 주요 인터페이스

### RAN (Radio Access Network) 인터페이스
- Uu 인터페이스: UE와 기지국 간
- N1 인터페이스: UE와 코어 네트워크 간

### 코어 네트워크 인터페이스
- N2 인터페이스: RAN과 AMF 간
- N3 인터페이스: RAN과 UPF 간
- N4 인터페이스: SMF와 UPF 간

## 프로토콜
- NR (New Radio): 5G 무선 접속 기술
- NAS: NR Application Services
- NGAP: Next Generation Application Protocol
EOF

echo "✅ 테스트 문서 생성 완료"
ls -lh ./test_docs/
```

**옵션 B: 기존 마크다운 파일 복사**
```bash
cp /path/to/your/documents/*.md ./test_docs/
```

---

### 단계 1: 문서 변환 및 자동 인덱싱

```bash
# 테스트 문서를 input 폴더에 복사
cp ./test_docs/*.md ./input/

# 파일 확인
echo "=== Input 폴더 파일 ==="
ls -lh ./input/

# 폴더 변환 실행 (자동 인덱싱 포함)
echo "=== 폴더 변환 및 인덱싱 시작 ==="
curl -X POST "http://localhost:8000/convert-folder?auto_index=true" \
  -w "\n%{http_code}\n"

# 변환 결과 확인
echo "=== Output 폴더 파일 ==="
sleep 2
ls -lh ./output/*.md 2>/dev/null || echo "아직 파일이 없습니다"
```

**예상 응답**:
```json
{
  "total_files": 4,
  "converted_files": 4,
  "failed_files": 0,
  "files": [
    {
      "input": "5G_network.md",
      "output": "5G_network.md",
      "status": "success",
      "indexed": true
    },
    {
      "input": "volte_technology.md",
      "output": "volte_technology.md",
      "status": "success",
      "indexed": true
    }
  ],
  "message": "Batch conversion complete: 4 succeeded, 0 failed"
}
```

---

### 단계 2: 인덱싱 상태 확인

```bash
echo "=== 인덱싱된 문서 목록 조회 ==="
curl "http://localhost:8000/documents" | jq '.'

# 인덱싱된 문서 수로 뽑기
TOTAL_DOCS=$(curl -s "http://localhost:8000/documents" | jq '.total_documents')
echo "✅ 총 인덱싱된 문서: $TOTAL_DOCS개"
```

**예상 응답**:
```json
{
  "total_documents": 45,
  "documents": [
    {
      "id": "doc_001_chunk_0",
      "source": "/app/output/5G_network.md",
      "chunk_index": 0
    },
    {
      "id": "doc_001_chunk_1",
      "source": "/app/output/5G_network.md",
      "chunk_index": 1
    }
  ]
}
```

---

### 단계 3: 검색 테스트 (Search)

#### 테스트 3-1: 단순 검색

```bash
echo "=== 검색 테스트 1: '5G' 검색 ==="
curl -s "http://localhost:8000/search?query=5G&top_k=3" | jq '.'
```

**예상 응답**:
```json
{
  "results": [
    {
      "content": "5G는 5세대 이동통신 기술로 초고속, 초저지연, 초연결을 특징으로 합니다...",
      "metadata": {
        "source": "/app/output/5G_network.md",
        "chunk_index": 0
      },
      "distance": 0.05
    }
  ],
  "total": 3
}
```

#### 테스트 3-2: 기술 관련 검색

```bash
echo "=== 검색 테스트 2: 'femtocell 5G' 검색 ==="
curl -s "http://localhost:8000/search?query=femtocell%205G&top_k=5" | jq '.results[0:2]'

echo ""
echo "=== 검색 테스트 3: 'VoLTE ViLTE' 검색 ==="
curl -s "http://localhost:8000/search?query=VoLTE+ViLTE&top_k=3" | jq '.results[0]'
```

---

### 단계 4: RAG 질의응답 테스트 (Query)

#### 테스트 4-1: 기본 질의

```bash
echo "=== RAG 질의 테스트 1: 5G의 특징 ==="
curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "5G 네트워크의 주요 특징을 설명해주세요",
    "top_k": 3
  }' | jq '.answer'

echo ""
echo "=== RAG 질의 테스트 1: 출처 확인 ==="
curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "5G 네트워크의 주요 특징을 설명해주세요",
    "top_k": 3
  }' | jq '.sources[0]'
```

**예상 응답**:
```json
{
  "answer": "5G 네트워크의 주요 특징은 다음과 같습니다:\n\n1. **초고속 데이터 전송**: 최대 20Gbps의 다운로드 속도를 제공합니다.\n2. **초저지연**: 1ms 이하의 매우 낮은 응답 시간을 보장합니다...",
  "sources": [
    {
      "content": "5G는 5세대 이동통신 기술로 초고속, 초저지연, 초연결을 특징으로 합니다.",
      "metadata": {
        "source": "/app/output/5G_network.md",
        "chunk_index": 0
      },
      "similarity": 0.95
    }
  ],
  "question": "5G 네트워크의 주요 특징을 설명해주세요"
}
```

#### 테스트 4-2: 기술 비교 질의

```bash
echo "=== RAG 질의 테스트 2: VoLTE vs ViLTE ==="
curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "VoLTE와 ViLTE의 차이점은 무엇인가요?",
    "top_k": 5
  }' | jq '{answer: .answer, source_count: (.sources | length)}'
```

#### 테스트 4-3: 기술 적용 범위 질의

```bash
echo "=== RAG 질의 테스트 3: 5G 적용 분야 ==="
curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "5G 기술이 어떤 분야에 적용되고 있나요?",
    "top_k": 3
  }' | jq '.answer'

echo ""
echo "=== RAG 질의 테스트 4: Femtocell의 역할 ==="
curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "femtocell이 5G 네트워크에서 어떤 역할을 하나요?",
    "top_k": 4
  }' | jq '.answer'
```

---

### 단계 5: 평가 시스템 테스트 (Evaluation)

#### 테스트 5-1: 테스트셋 생성

```bash
echo "=== 테스트셋 생성 시작 ==="
curl -X POST "http://localhost:8000/testset/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "input_dir": "/app/output",
    "output_file": "output/testset_sample.csv",
    "test_size": 5
  }'
```

#### 테스트 5-2: 검색 성능 평가

```bash
echo "=== 검색 성능 평가 시작 ==="
# 생성된 테스트셋 파일이 로컬 output 폴더에 마운트되어 있다고 가정
curl -X POST "http://localhost:8000/evaluate" \
  -F "file=@output/testset_sample.csv" \
  -F "top_k=5"
```

---

### 단계 6: 결과 검증

```bash
echo "=== 최종 검증 ==="

# 1. 문서 수 확인
TOTAL=$(curl -s "http://localhost:8000/documents" | jq '.total_documents')
echo "✅ 인덱싱된 문서 수: $TOTAL"

# 2. 검색 동작 확인
SEARCH=$(curl -s "http://localhost:8000/search?query=5G" | jq '.total')
echo "✅ 검색 결과 수: $SEARCH"

# 3. RAG 동작 확인
RAG=$(curl -s -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{"question": "주요 특징은?"}' | jq 'has("answer")')
echo "✅ RAG 동작: $RAG"

echo ""
echo "✅ 모든 테스트 완료!"
```

---

## 자세한 사항은 howto.md 참조

더 자세한 API 사용법, 파라미터, 응답 형식은 [howto.md](./howto.md)를 참조하세요.
