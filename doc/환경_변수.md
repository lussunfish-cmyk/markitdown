# 환경 변수 설정 가이드

MarkItDown RAG 시스템의 모든 설정은 환경 변수로 오버라이드할 수 있습니다.
이 문서에서는 각 설정 항목과 환경 변수를 설명합니다.

## 📋 목차

- [로깅 설정](#로깅-설정)
- [Ollama 설정](#ollama-설정)
- [벡터 저장소 설정](#벡터-저장소-설정)
- [청킹 설정](#청킹-설정)
- [검색 설정](#검색-설정)
- [캐시 설정](#캐시-설정)
- [RAG 설정](#rag-설정)
- [파일 변환 설정](#파일-변환-설정)
- [인덱싱 설정](#인덱싱-설정)
- [배치 처리 설정](#배치-처리-설정)
- [API 설정](#api-설정)
- [사용 예시](#사용-예시)

---

## 로깅 설정

| 환경 변수 | 기본값 | 설명 | 예시 |
|---------|--------|------|------|
| `LOG_LEVEL` | `INFO` | 로깅 레벨 | `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL` |
| `LOG_FORMAT` | `%(asctime)s - %(name)s - %(levelname)s - %(message)s` | 로그 포맷 문자열 | `[%(asctime)s] %(levelname)s - %(message)s` |
| `LOG_DATE_FORMAT` | `%Y-%m-%d %H:%M:%S` | 로그 타임스탬프 포맷 | `%Y-%m-%d %H:%M:%S.%f` |

### 로깅 설정 예시

```bash
# 디버그 레벨로 상세 로깅
export LOG_LEVEL=DEBUG
export LOG_FORMAT="[%(asctime)s] %(name)s - %(levelname)s - %(message)s"

# 또는 간단하게
export LOG_LEVEL=WARNING
```

---

## Ollama 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `OLLAMA_BASE_URL` | `http://localhost:11434` | Ollama 서버 주소 |
| `OLLAMA_EMBEDDING_MODEL` | `mxbai-embed-large` | 임베딩 모델명 |
| `OLLAMA_LLM_MODEL` | `gemma2` | LLM 모델명 |
| `OLLAMA_TIMEOUT` | `300` | 요청 타임아웃 (초) |
| `OLLAMA_MAX_RETRIES` | `3` | 최대 재시도 횟수 |
| `OLLAMA_RETRY_DELAY` | `1.0` | 재시도 간 대기시간 (초) |

### Ollama 설정 예시

```bash
# 원격 Ollama 서버 사용
export OLLAMA_BASE_URL=http://ollama-server:11434

# 다른 모델 사용
export OLLAMA_LLM_MODEL=llama2
export OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# 타임아웃 설정
export OLLAMA_TIMEOUT=600
export OLLAMA_MAX_RETRIES=5
```

---

## 벡터 저장소 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `VECTOR_STORE_TYPE` | `chroma` | 저장소 타입 (`chroma` 또는 `faiss`) |
| `VECTOR_STORE_DIR` | `/app/vector_store` | 벡터 저장소 디렉토리 |
| `CHROMA_COLLECTION_NAME` | `documents` | ChromaDB 컬렉션명 |
| `EMBEDDING_DIM` | `1024` | 임베딩 벡터 차원 |

### 벡터 저장소 설정 예시

```bash
# ChromaDB 커스텀 경로
export VECTOR_STORE_DIR=/data/vector_store
export CHROMA_COLLECTION_NAME=my_documents

# 임베딩 차원 (nomic-embed-text는 768)
export EMBEDDING_DIM=768
```

---

## 청킹 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `CHUNK_SIZE` | `512` | 청크 크기 (문자 단위) |
| `CHUNK_OVERLAP` | `128` | 청크 간 겹침 크기 (문자 단위) |

### 청킹 설정 예시

```bash
# 긴 청크 (메모리 여유 있을 때)
export CHUNK_SIZE=1024
export CHUNK_OVERLAP=256

# 짧은 청크 (더 정확한 검색)
export CHUNK_SIZE=256
export CHUNK_OVERLAP=64
```

:::info
**참고**: `CHUNK_OVERLAP`은 `CHUNK_SIZE`보다 작아야 합니다.
:::

---

## 검색 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `RETRIEVER_HYBRID_ALPHA` | `0.7` | 하이브리드 검색 가중치 (0~1) |
| `RETRIEVER_RRF_K` | `60` | RRF 파라미터 |
| `RETRIEVER_DEFAULT_TYPE` | `advanced` | 기본 검색 타입 |

### 가중치 설명

- **HYBRID_ALPHA**: 
  - `1.0`: 벡터 검색만 사용
  - `0.7`: 벡터 검색 70%, 키워드 검색 30%
  - `0.0`: 키워드 검색만 사용

### 검색 설정 예시

```bash
# 벡터 검색 우선 (시맨틱 검색 강조)
export RETRIEVER_HYBRID_ALPHA=0.9

# 균형잡힌 검색
export RETRIEVER_HYBRID_ALPHA=0.5

# 키워드 검색 우선 (정확한 매칭 중요)
export RETRIEVER_HYBRID_ALPHA=0.3

# RRF 파라미터 조정
export RETRIEVER_RRF_K=80

# 기본 검색 타입 변경
export RETRIEVER_DEFAULT_TYPE=hybrid  # vector, bm25, hybrid, advanced
```

---

## 캐시 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `CACHE_ENABLED` | `true` | 캐싱 활성화 여부 |
| `CACHE_SEARCH_MAXSIZE` | `100` | 검색 결과 캐시 최대 개수 |
| `CACHE_SEARCH_TTL` | `300` | 검색 결과 캐시 유지 시간 (초) |

### 캐시 설정 예시

```bash
# 캐싱 비활성화
export CACHE_ENABLED=false

# 캐시 크기 증가 (많은 쿼리 처리)
export CACHE_SEARCH_MAXSIZE=500
export CACHE_SEARCH_TTL=600

# 캐시 크기 감소 (메모리 제한)
export CACHE_SEARCH_MAXSIZE=50
export CACHE_SEARCH_TTL=120
```

---

## RAG 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `RAG_TOP_K` | `5` | 검색할 문서 개수 |
| `RAG_SIMILARITY_THRESHOLD` | `0.5` | 유사도 임계값 (0~1) |
| `RAG_TEMPERATURE` | `0.3` | LLM 온도 (0~2) |
| `RAG_TOP_P` | `0.9` | Top-p 샘플링 파라미터 |
| `RAG_MAX_TOKENS` | `512` | 생성할 최대 토큰 수 |
| `RAG_MAX_CONTEXT_LENGTH` | `8192` | 최대 컨텍스트 길이 (문자) |

### 온도(Temperature) 설명

- **낮은 값 (0.1~0.3)**: 일관성 있고 결정적인 답변 (정확성 중요할 때)
- **중간 값 (0.5~0.7)**: 창의성과 정확성의 균형
- **높은 값 (0.9~2.0)**: 창의적이고 다양한 답변

### RAG 설정 예시

```bash
# 정확한 답변 (고객 지원, FAQ)
export RAG_TOP_K=3
export RAG_TEMPERATURE=0.1
export RAG_MAX_TOKENS=256

# 균형잡힌 설정 (일반적인 Q&A)
export RAG_TOP_K=5
export RAG_TEMPERATURE=0.3
export RAG_MAX_TOKENS=512

# 창의적인 답변 (브레인스토밍, 생성)
export RAG_TOP_K=7
export RAG_TEMPERATURE=0.7
export RAG_MAX_TOKENS=1024

# 더 많은 컨텍스트 사용
export RAG_MAX_CONTEXT_LENGTH=16384
```

---

## 파일 변환 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `MARKITDOWN_OUTPUT_DIR` | `/app/output` | 변환 결과 저장 디렉토리 |
| `MARKITDOWN_INPUT_DIR` | `/app/input` | 입력 파일 디렉토리 |
| `LIBREOFFICE_TIMEOUT` | `60` | LibreOffice 타임아웃 (초) |

### 파일 변환 설정 예시

```bash
# 커스텀 디렉토리
export MARKITDOWN_OUTPUT_DIR=/data/output
export MARKITDOWN_INPUT_DIR=/data/input

# LibreOffice 타임아웃 증가
export LIBREOFFICE_TIMEOUT=120
```

---

## 인덱싱 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `DOCUMENT_DIR` | `/app/output` | 문서 디렉토리 |
| `INDEX_STATE_FILE` | `/app/vector_store/index_state.json` | 인덱싱 상태 파일 |
| `WATCH_INTERVAL` | `10` | 감시 모드 체크 간격 (초) |

### 인덱싱 설정 예시

```bash
# 커스텀 문서 디렉토리
export DOCUMENT_DIR=/data/documents
export INDEX_STATE_FILE=/data/index_state.json

# 감시 모드 간격 조정
export WATCH_INTERVAL=30
```

---

## 배치 처리 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `BATCH_STATE_DIR` | `/app/batch_state` | 배치 상태 저장 디렉토리 |
| `DEFAULT_BATCH_SIZE` | `100` | 기본 배치 크기 |
| `BATCH_TIMEOUT` | `0` | 배치 처리 타임아웃 (초, 0=무제한) |
| `BATCH_HASH_LENGTH` | `6` | 배치 ID 해시 길이 |

### 배치 처리 설정 예시

```bash
# 배치 상태 저장 디렉토리
export BATCH_STATE_DIR=/data/batch_state

# 배치 크기 조정
export DEFAULT_BATCH_SIZE=50

# 배치 타임아웃 설정 (1시간)
export BATCH_TIMEOUT=3600

# 배치 ID 해시 길이 증가 (더 고유함)
export BATCH_HASH_LENGTH=8
```

---

## API 설정

| 환경 변수 | 기본값 | 설명 |
|---------|--------|------|
| `API_TITLE` | `MarkItDown RAG API` | API 타이틀 |
| `API_VERSION` | `1.0.0` | API 버전 |
| `API_DESCRIPTION` | `문서 변환, 벡터 인덱싱, RAG 기반 질의응답 API` | API 설명 |
| `CORS_ORIGINS` | `*` | CORS 허용 출처 (쉼표로 구분) |
| `API_DOCS_URL` | `/docs` | Swagger 문서 경로 |
| `API_REDOC_URL` | `/redoc` | ReDoc 문서 경로 |

### API 설정 예시

```bash
# 커스텀 API 정보
export API_TITLE="My Company RAG API"
export API_VERSION="2.0.0"
export API_DESCRIPTION="문서 검색 및 QA 시스템"

# CORS 설정 (특정 도메인만 허용)
export CORS_ORIGINS="http://localhost:3000,https://example.com"

# API 문서 경로 변경
export API_DOCS_URL=/api/docs
export API_REDOC_URL=/api/redoc
```

---

## 사용 예시

### 1. 쉘 스크립트에서 설정

```bash
#!/bin/bash

# 환경 변수 파일 생성
cat > .env << EOF
# 로깅
LOG_LEVEL=DEBUG

# Ollama
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_LLM_MODEL=gemma2
OLLAMA_EMBEDDING_MODEL=mxbai-embed-large

# RAG
RAG_TOP_K=5
RAG_TEMPERATURE=0.3
RAG_MAX_TOKENS=512

# 캐시
CACHE_ENABLED=true
CACHE_SEARCH_MAXSIZE=100
CACHE_SEARCH_TTL=300

# API
API_TITLE="MarkItDown RAG API"
API_VERSION="1.0.0"
EOF

# 조성 파일에서 로드
docker compose --env-file .env up
```

### 2. Docker Compose에서 설정

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    environment:
      - LOG_LEVEL=INFO
      - OLLAMA_BASE_URL=http://ollama:11434
      - RAG_TOP_K=5
      - RAG_TEMPERATURE=0.3
      - CACHE_ENABLED=true
      - API_TITLE=MarkItDown RAG API
```

### 3. 직접 명령어로 설정

```bash
# 단일 환경 변수
export RAG_TEMPERATURE=0.5
python -m app.converter

# 여러 환경 변수
export RAG_TOP_K=7
export RAG_TEMPERATURE=0.7
export CACHE_ENABLED=true
docker compose up
```

### 4. 프로덕션 설정

```bash
# 프로덕션.env 파일
cat > .env.prod << EOF
# 로깅 (최소 로깅)
LOG_LEVEL=WARNING

# Ollama (원격 서버)
OLLAMA_BASE_URL=http://ollama-prod:11434
OLLAMA_TIMEOUT=600
OLLAMA_MAX_RETRIES=5

# RAG (최적화)
RAG_TOP_K=5
RAG_TEMPERATURE=0.2
RAG_MAX_TOKENS=1024
RAG_MAX_CONTEXT_LENGTH=16384

# 캐시 (큰 성능 향상)
CACHE_ENABLED=true
CACHE_SEARCH_MAXSIZE=500
CACHE_SEARCH_TTL=600

# 검색 (하이브리드)
RETRIEVER_HYBRID_ALPHA=0.7
RETRIEVER_DEFAULT_TYPE=advanced

# API
API_TITLE=Production RAG API
CORS_ORIGINS=https://example.com,https://api.example.com
EOF

docker compose --env-file .env.prod up -d
```

### 5. 개발 환경 설정

```bash
# 개발.env 파일
cat > .env.dev << EOF
# 로깅 (상세)
LOG_LEVEL=DEBUG
LOG_FORMAT=[%(asctime)s] %(name)s - %(levelname)s - %(message)s

# Ollama (로컬)
OLLAMA_BASE_URL=http://localhost:11434

# RAG (빠른 테스트)
RAG_TOP_K=3
RAG_TEMPERATURE=0.5

# 캐시 (작은 캐시)
CACHE_ENABLED=true
CACHE_SEARCH_MAXSIZE=50

# 검색 (벡터)
RETRIEVER_DEFAULT_TYPE=vector
RETRIEVER_HYBRID_ALPHA=1.0

# API
API_TITLE=Development RAG API
CORS_ORIGINS=*
EOF

docker compose --env-file .env.dev up
```

---

## 🔍 설정 검증

설정값이 올바른지 확인하려면:

```bash
# Python에서 설정 확인
python -c "from app.config import config; import json; print(json.dumps(config.get_all_settings(), indent=2))"
```

---

## ⚠️ 주의사항

1. **CHUNK_OVERLAP >= CHUNK_SIZE**: 에러 발생
   ```bash
   # ❌ 잘못된 설정
   export CHUNK_SIZE=512
   export CHUNK_OVERLAP=600
   
   # ✅ 올바른 설정
   export CHUNK_SIZE=512
   export CHUNK_OVERLAP=128
   ```

2. **HYBRID_ALPHA 범위**: 0.0 ~ 1.0
   ```bash
   # ❌ 잘못된 설정
   export RETRIEVER_HYBRID_ALPHA=1.5
   
   # ✅ 올바른 설정
   export RETRIEVER_HYBRID_ALPHA=0.7
   ```

3. **RAG_TEMPERATURE 범위**: 0.0 ~ 2.0
   ```bash
   # ❌ 잘못된 설정
   export RAG_TEMPERATURE=5.0
   
   # ✅ 올바른 설정
   export RAG_TEMPERATURE=0.7
   ```

4. **환경 변수 타입**:
   - 정수: `RAG_TOP_K`, `CHUNK_SIZE` 등
   - 실수: `RAG_TEMPERATURE`, `RETRIEVER_HYBRID_ALPHA` 등
   - 문자열: `LOG_LEVEL`, `OLLAMA_BASE_URL` 등
   - 불린: `CACHE_ENABLED` (true/false)

---

## 📚 참고 문서

- [config.py 구조](./구현/config_구현.md)
- [RAG 설정 상세](./howto.md)
- [배치 처리 설정](./구현/batch_manager_구현.md)
